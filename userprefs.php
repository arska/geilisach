<?include("connect.inc.php");include("auth.inc.php");include("functions.inc.php");$onlytestforadminbit = true;include("admin.inc.php");// wenn es ein neuer User ist, müssen default-werte her:include("userdefaults.inc.php");$messages = array();$errors = array();if ($_REQUEST['saveuserprefs']) {	$username = addslashes(trim($_REQUEST['username']));		if (!$username) {		array_push($errors,"Keinen Usernamen angegeben.");	}		$sql = "SELECT UID FROM chat_user WHERE username = '$username' LIMIT 1;";	$result = mysql_query($sql);	$row = mysql_fetch_row($result);	if (!(mysql_num_rows($result) == 0 || (mysql_num_rows($result) == 1 && $row[0] == $_SESSION['UID']))) { //(($row[0] && $row[0] != $_SESSION['UID']) || $row[0] == 0)		array_push($errors,"Es gibt bereits einen anderen User mit Namen '$username', bitte einen anderen w&auml;hlen.");	}		$disclose = "";	if ($_REQUEST['fullnamedisclose']) $disclose .= "fullname,";	if ($_REQUEST['herkunftdisclose']) $disclose .= "herkunft,";	if ($_REQUEST['emaildisclose']) $disclose .= "email,";	if ($_REQUEST['nateldisclose']) $disclose .= "natel,";		if ((integer)$_REQUEST['gebjahr'] && (integer)$_REQUEST['gebjahr'] < 100) $gebjahr = (integer)$_REQUEST['gebjahr'] + 1900; // hehe, ist halt für unsere Generation	else $gebjahr = (integer)$_REQUEST['gebjahr'];	$gebmon = (integer)$_REQUEST['gebmon'];	$gebtag = (integer)$_REQUEST['gebtag'];		if (checkdate($gebmon,$gebtag,$gebjahr)) {		$gebdate = str_pad($gebjahr, 4, "0", STR_PAD_LEFT)."-".str_pad($gebmon, 2, "0", STR_PAD_LEFT)."-".str_pad($gebtag, 2, "0", STR_PAD_LEFT);	} else {		array_push($errors,"Das Datum '".str_pad($gebtag, 2, "0", STR_PAD_LEFT).".".str_pad($gebmon, 2, "0", STR_PAD_LEFT).".".str_pad($gebjahr, 4, "0", STR_PAD_LEFT)."' ist ung&uuml;ltig.");	}		if ($_REQUEST['mf']) {		if ($_REQUEST['mf'] == "m") $mf = "m";		else $mf = "f";	} else array_push($errors,"Du hast nicht angegeben, ob du Mann oder Frau bist.");		$fullname = addslashes(htmlentities(trim($_REQUEST['fullname'])));		$herkunft = addslashes(htmlentities(trim($_REQUEST['herkunft'])));		if (trim($_REQUEST['password'])) {		$password = addslashes(trim($_REQUEST['password']));		array_push($messages,"Passwort wurde ge&auml;andert.");	} else $nopassupdate = true;		$email = addslashes(trim($_REQUEST['email']));		$natel = addslashes(trim($_REQUEST['natel']));		$skype = addslashes(trim($_REQUEST['skype']));		$beschreibung = addslashes(nl2br(htmlentities(trim($_REQUEST['beschreibung']))));		$homepage = addslashes(trim($_REQUEST['homepage']));	if ($homepage != "" && $homepage != "http://") {		if (!substr($homepage, 0, 7) == "http://") $homepage = "http://".$homepage;	} else $homepage = "";		$ownpic = (integer)$_REQUEST['ownpic'];	if (!$ownpic) $ownpic = 0;		$_SESSION['zeilen'] = (integer)$_REQUEST['zeilen'];	if ($_SESSION['zeilen'] < 5) {		$_SESSION['zeilen'] = 5; // min = 5		array_push($messages,"Weniger als 5 Zeilen anzuzeigen ist nicht besonders sinnvoll..");	}	if ($_SESSION['zeilen'] > 50) {		$_SESSION['zeilen'] = 50; // max = 50		array_push($messages,"Mehr als 50 Zeilen anzuzeigen ist nicht besonders sinnvoll.. Daf&uuml;r gibts das Nachlesen im Menu.");	}		$_SESSION['refresh'] = (integer)$_REQUEST['refresh'];	if ($_SESSION['refresh'] < 2) {		$_SESSION['refresh'] = 2;		array_push($messages,"&Ouml;fter als alle 2 Sekunden zu aktualisieren ist nicht besonders sinnvoll und erh&ouml;ht den Traffic des Servers unverh&auml;ltnism&auml;ssig.");		}	if ($_SESSION['refresh'] > 20) {		array_push($messages,"Bist du sicher, dass du neue Beitr&auml;ge erst nach {$_SESSION['refresh']} Sekunden sehen willst ?");	}			if ($_REQUEST['watchusers']) $_SESSION['watchusers'] = 1;	else $_SESSION['watchusers'] = 0;	if ($_REQUEST['turnus']) $_SESSION['turnus'] = 1;	else $_SESSION['turnus'] = 0;	if ($_REQUEST['inputfocus']) $_SESSION['inputfocus'] = 1;	else $_SESSION['inputfocus'] = 0;	if ($_REQUEST['reloadsaver']) $_SESSION['reloadsaver'] = 1;	else $_SESSION['reloadsaver'] = 0;		if ($_REQUEST['newbutton']) array_push($_SESSION['inputbuttons'],$_REQUEST['newbutton']);	if ($_REQUEST['deletebutton']) $_SESSION['inputbuttons'] = array_unique(array_diff($_SESSION['inputbuttons'],array((string)$_REQUEST['deletebutton'])));		if ($_REQUEST['inputlogo']) $_SESSION['inputlogo'] = 1;	else $_SESSION['inputlogo'] = 0;					if ($adminbit && $_REQUEST['autoextra']) $_SESSION['autoextra'] = 1;	else $_SESSION['autoextra'] = 0;		if ($adminbit && $_REQUEST['invisible']) {		$invisible = 1;	} else $invisible = 0;		// hack, damit niemand in den prefs mitgespeichert wird und dann nicht alarmiert würde..	$temponlineusers = (array)$_SESSION['knownusers'];	$_SESSION['knownusers'] = array();		$preferences = addslashes(session_encode());		$_SESSION['knownusers'] = (array)$temponlineusers;		if (count($errors) < 1) { // keine fehler		$sql = "UPDATE chat_user SET username = '$username', fullname = '$fullname', herkunft = '$herkunft',";		if (!$nopassupdate) $sql .= " password = '$password',";		$sql .= "mf = '$mf', invisible = '$invisible', email = '$email', natel = '$natel', skype = '$skype', geburi = '$gebdate', beschreibung = '$beschreibung', homepage = '$homepage', ownpic = '$ownpic', disclose = '$disclose', preferences = '$preferences', lastedit = NOW() WHERE UID = '".$_SESSION['UID']."' LIMIT 1;";		if (mysql_query($sql)) array_push($messages,"Voreinstellungen gespeichert.");		else array_push($errors,"Voreinstellungen konnten nicht gespeichert werden..");	} else array_push($errors,"Voreinstellungen wurden wegen genannten Fehlern nicht gespeichert.");}if ($_REQUEST['firstpref'] && (count($errors) < 1)) { // erstes gültiges submit	$refreshurl = "index.php";	include("header.inc.php");	echo "Es geht <a href=\"index.php\">zur Hauptseite</a>..";	include("footer.inc.php");	exit;}if ($_REQUEST['makepersistent']) {	$uniquekey = md5($_SESSION['UID'] . $_SESSION['username'] . (double)microtime()*1000000);	// diesen key in die DB und in ein Cookie schreiben	$sql = "UPDATE chat_user SET cookie = '$uniquekey', lastedit = NOW() WHERE UID = '".$_SESSION['UID']."' LIMIT 1;";	if (mysql_query($sql) && SetCookie("persistentlogin",$uniquekey,time()+3600*365*1,"/")) { // wenn beidesmal erfolgreich -> flag		array_push($messages,"Persistent cookie gespeichert.");		$makesuccess = true;	} else array_push($errors,"Persistent cookie konnte nicht angelegt werden. Sind vielleicht cookies im browser deaktiviert ?");}if ($_REQUEST['killpersistent']) {	$sql = "UPDATE chat_user SET cookie = '', lastedit = NOW() WHERE UID = '".$_SESSION['UID']."' LIMIT 1;";	if (mysql_query($sql) && SetCookie("persistentlogin","",time()-3600,"/")) { // wenn erfolgreich gelöscht -> flag		array_push($messages,"Persistent cookie gel&ouml;scht.");	} else {		array_push($errors,"Persistent cookie konnte nicht gel&ouml;scht werden.");		$killfailed = true;	}}$sql = "SELECT * FROM chat_user WHERE UID = '".$_SESSION['UID']."' LIMIT 1;";$result = mysql_query($sql);$row = mysql_fetch_array($result);$_SESSION['username'] = $row['username']; // nötig wenn ein (l)user das erste mal unterwegs ist und noch keine session hat$title = "Voreinstellungen";include("header.inc.php");echo "<center>";echo "<form method=\"post\" action=\"{$_SERVER['PHP_SELF']}\">";if ($_REQUEST['newuser'] || ($_REQUEST['firstpref'] && (count($errors) > 0))) { // das erste mal auf der seite, oder boomerang beim ersten speichern	array_push($messages, "Hallo '".htmlentities($row['username'])."' !<br>Damit deine Registration vollendet wird, musst du deine Voreinstellungen speichern, d.h. <b>unten noch auf 'Speichern' klicken.</b><br>Du kannst diese Daten jederzeit unter 'Voreinstellungen' einsehen und &auml;ndern.");	echo "<input type=\"hidden\" name=\"firstpref\" value=\"true\">";}if (count($errors) > 0) {	for ($i=0; $i<count($errors); $i++) echo "<font color=\"red\">{$errors[$i]}</font><br>";}if (count($messages) > 0) {	for ($i=0; $i<count($messages); $i++) echo $messages[$i]."<br>";}?><table width="75%" border="1"><tr><td><table border="0" cellspacing="0" cellpadding="4"><tr>	<td>Username</td>	<td><input type="text" name="username" value="<?=$row['username'] ?>"></td>	<td>Deinen Chat-Namen</td></tr><tr>	<td>Passwort</td>	<td><input type="password" name="password" value=""></td>	<td>Hier kannst du dein Passwort &auml;ndern.</td></tr><tr>	<td>Vorname Nachname</td>	<td><input type="text" name="fullname" value="<?=$row['fullname'] ?>"><br><input type="checkbox" name="fullnamedisclose" value="1" <? if (in_array("fullname",explode(",",$row['disclose']))) echo " checked=\"checked\"" ?>>F&uuml;r alle sichtbar</td>	<td>Deinen (richtigen) Namen</td></tr><tr>	<td>Herkunft</td>	<td><input type="text" name="herkunft" value="<?=$row['herkunft'] ?>"><br><input type="checkbox" name="herkunftdisclose" value="1" <? if (in_array("herkunft",explode(",",$row['disclose']))) echo " checked=\"checked\"" ?>>F&uuml;r alle sichtbar</td>	<td>Wo kommst du her ?</td></tr><tr>	<td>Emailadresse</td>	<td><input type="text" name="email" value="<?=$row['email'] ?>"><br><input type="checkbox" name="emaildisclose" value="1" <? if (in_array("email",explode(",",$row['disclose']))) echo " checked=\"checked\"" ?>>F&uuml;r alle sichtbar</td>	<td><? if ($invalidemail) { ?><font color="red">Emailadresse ung&uuml;ltig!</font><? } else { ?>Email-Adresse f&uuml;r updates, verlorenes Passwort usw.<? } ?></td></tr><tr>	<td>Natel-Nr.</td>	<td><input type="text" name="natel" value="<?=$row['natel'] ?>"><br><input type="checkbox" name="nateldisclose" value="1" <? if (in_array("natel",explode(",",$row['disclose']))) echo " checked=\"checked\"" ?>>F&uuml;r alle sichtbar</td>	<td></td></tr><tr>	<td>Skype-ID</td>	<td><input type="text" name="skype" value="<?=$row['skype'] ?>"></td>	<td>Skype ist ein gratis plattform-&uuml;bergreifendes Internet-Telefonie-System, siehe <a target="_blank" href="http://www.skype.com/">Skype.com</a></td></tr><tr>	<td>Geburtstag</td>	<td><input type="text" name="gebtag" value="<?=substr($row['geburi'],8,2) ?>" size="2">.<input type="text" name="gebmon" value="<?=substr($row['geburi'],5,2) ?>" size="2">.<input type="text" name="gebjahr" value="<?=substr($row['geburi'],0,4) ?>" size="4"></td>	<td>Damit dir die anderen User dann grosse Geschenke schenken k&ouml;nnen =)</td></tr><tr>	<td>M/F</td>	<td><input type="radio" name="mf" value="m" <?=($row['mf'] == "m" ? "checked=\"checked\"" : "") ?>> Mann<br><input type="radio" name="mf" value="f" <?=($row['mf'] == "f" ? "checked=\"checked\"" : "") ?>> Frau</td>	<td></td></tr><tr>	<td>Beschreibung</td>	<td><textarea name="beschreibung" rows="4" cols="30"><?=stripslashes(str_replace("<br />","",$row['beschreibung'])) ?></textarea></td>	<td>Eine kleine Beschreibung wer du bist, woher man dich kennt usw..</td></tr><tr>	<td>Homepage</td>	<td><input type="text" name="homepage" value="<? if ($row['homepage']) echo $row['homepage']; else echo "http://";?>"></td>	<td>Wenn du eine Homepage hast, machen wir einen Link darauf.</td></tr><tr>	<td>Bild</td>	<td colspan="2"><select name="ownpic">	<?	if (!$row['ownpic']) echo "<option value=\"0\">--keines--</option>";		$sql = "SELECT ID,name FROM bilder_info WHERE ID = parent ORDER BY ID ASC;";	$bildresult = mysql_query($sql);	while ($bildrow = mysql_fetch_row($bildresult)) {		echo "<option value=\"{$bildrow[0]}\"";		if ($bildrow[0] == $row['ownpic']) echo " selected=\"selected\"";		echo ">{$bildrow[0]}: {$bildrow[1]}</option>";	}		?>	</select></td></tr><tr>	<td>&nbsp;</td>	<td></td>	<td></td></tr><tr>	<td>Zeilen</td>	<td><input type="text" name="zeilen" value="<?=$_SESSION['zeilen'] ?>"></td>	<td>Wieviele Zeilen sollen angezeigt werden im chat?<br>Eine hohe Anzahl Zeilen kann deinen Browser &uuml;berfordern.. (min 5, max 50)</td></tr><tr>	<td>Refresh</td>	<td>alle <input type="text" name="refresh" value="<?=$_SESSION['refresh'] ?>">sec.</td>	<td>Wieviele Sekunden sollen zwischen den chat-updates vergehen ? (min 2)</td></tr><tr>	<td>Neue-User-Alert</td>	<td><input type="checkbox" name="watchusers" value="ja"<? if ($_SESSION['watchusers']) echo " checked"; ?>></td>	<td>Willst du speziell darauf aufmerksam gemacht werden, wenn sich neue User im Chat befinden ?</td></tr><tr>	<td>Turnus</td>	<td><input type="checkbox" name="turnus" value="ja"<? if ($_SESSION['turnus']) echo " checked"; ?>></td>	<td>Soll der Bilder-Turnus aktiviert werden ?</td></tr><tr>	<td>Input-Focus</td>	<td><input type="checkbox" name="inputfocus" value="ja"<? if ($_SESSION['inputfocus']) echo " checked"; ?>></td>	<td>Soll das Schreibfeld automatisch angew&auml;hlt werden (JavaScript) ?</td></tr><tr>	<td>Reload-Saver</td>	<td><input type="checkbox" name="reloadsaver" value="ja"<? if ($_SESSION['reloadsaver']) echo " checked"; ?>></td>	<td>Bewirkt ein erneuts Aktualisieren des Chatfensters, falls das Fenster nicht Aktualisiert werden konnte (JavaScript). Verhindert das sogenannte "usefuule".</td></tr><tr>	<td>Buttons</td>	<td>Neuer Button:<input type="text" name="newbutton" value=""><br>Button L&ouml;schen:<select name="deletebutton"><option value="">-- ausw&auml;hlen --</option>	<?	foreach ($_SESSION['inputbuttons'] as $button) echo "<option>$button</option>";	?>	</select> <input type="submit" name="saveuserprefs" value="L&ouml;schen"></td>	<td></td></tr><tr>	<td>Logo</td>	<td><input type="checkbox" name="inputlogo" value="ja"<? if ($_SESSION['inputlogo']) echo " checked"; ?>></td>	<td>Das offizielle Geilisach-Logo an prominentester Stelle.</td></tr><?if ($adminbit) {	echo "<tr><td colspan=\"3\">&nbsp;</td></tr>";	echo "<tr><td colspan=\"3\">Admin-Extras</td></tr>";	echo "<tr><td>Auto Extra Info</td><td><input type=\"checkbox\" name=\"autoextra\" value=\"ja\"".($_SESSION['autoextra'] ? " checked=\"checked\"" : "")."></td><td>Automatische weiterleitung von userinfo auf userinfoextra</td></tr>";	echo "<tr><td>Invisible</td><td><input type=\"checkbox\" name=\"invisible\" value=\"ja\"".($row['invisible'] ? " checked=\"checked\"" : "")."></td><td>Unsichtbares chatten.. =)</td></tr>";}?><tr><td></td><td align="right"><input type="submit" name="saveuserprefs" value="Speichern"></td><td></td></tr><tr><td colspan="3">Diese Voreinstellungen werden gespeichert und bei jedem login neu geladen.<!-- - unabh&auml;ngig davon was du im oberen chatfenster gewhlt hast ! --></td></tr></table></td></tr></table></form><form method="post" action="<?=$_SERVER['PHP_SELF'] ?>"><table width="75%" border="1"><tr><td><table border="0" cellspacing="0" cellpadding="4"><tr>	<td></td>	<td align="right">		<? if (($_COOKIE['persistentlogin'] && $killfailed) || $makesuccess) { ?>			persistent cookie ist aktiv.<br><input type="submit" name="killpersistent" value="persistent-cookie Deaktivieren">		<? } else { ?>			persistent-cookie ist nicht aktiv.<br><input type="submit" name="makepersistent" value="persistent-cookie Aktivieren">		<? } ?></td>	<td>Wenn du willst, kannst du <b>automatisches login</b> aktivieren.<br>Das heisst, dass jeder von diesem Computer als '<?=htmlentities($_SESSION['username']) ?>' im chat angemeldet wird.<br>Diese Funktion ist auf einen einzigen Computer beschr&auml;nkt.</td></tr></table></td></tr></table></form></center><?	include("footer.inc.php");?>